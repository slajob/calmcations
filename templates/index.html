<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HotSpot</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin-bottom: 70px;
        }
        h1 {
            text-align: center;
            margin: 10px 0;
            flex-shrink: 0;
        }
        .content-wrapper {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 50px);
        }
        #map {
            flex: 1;
            width: 100%;
            min-height: 100px;
        }
        .input-group {
            background-color: #f0f0f0;
            padding: 10px;
            overflow-y: auto;
            max-height: 50vh;
            margin-bottom: 70px;
        }
        .location-buttons {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .location-buttons button {
            width: 48%;
            padding: 15px 10px;
            font-size: 16px;
        }
        input, button, select {
            width: 100%;
            margin-bottom: 10px;
            padding: 10px;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .active {
            background-color: #45a049;
        }
        #additionalInputs {
            display: none;
        }
        #flash-messages {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 11000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .flash {
            padding: 12px 18px;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            color: white;
            font-weight: bold;
            animation: fadeout 4s forwards;
        }
        .flash.error { background-color: #e74c3c; }
        .flash.success { background-color: #2ecc71; }
        .flash.info { background-color: #3498db; }
        @keyframes fadeout {
          0% { opacity: 1; }
          70% { opacity: 1; }
          100% { opacity: 0; transform: translateY(-20px); }
        }
        #heatFilter {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div id="flash-messages">
          {% for category, message in messages %}
            <div class="flash {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}
    <h1>HotSpot</h1>
    <div class="content-wrapper">
        <div id="map"></div>
        <div class="input-group">
            <select id="heatFilter" onchange="loadLocations()">
                <option value="" disabled selected>Filter by heat level:</option>
                <option value="all">All</option>
                <option value="veryhot">Very Hot ðŸ”¥</option>
                <option value="medium">Medium ðŸŸ </option>
                <option value="coldish">Coldish ðŸ§Š</option>
                <option value="grayout">Grayout âšª</option>
            </select>
            <div class="location-buttons">
                <button onclick="chooseLocationMethod('auto')" id="autoLocateBtn">Locate me</button>
                <button onclick="chooseLocationMethod('manual')" id="manualLocateBtn">Choose manually</button>
            </div>
            <div id="additionalInputs">
                <input type="text" id="name" placeholder="Location name">
                <button onclick="addSpotLocation()" id="addKanarButton">Add spot location</button>
            </div>
        </div>
    </div>

<script>
    var map = L.map('map').setView([50.0647, 19.9450], 12);
    var markers = {};
    var tempMarker = null;
    var isManualPlacementMode = false;
    var currentFilter = 'all';

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    function showFlash(message, category="info") {
        let container = document.getElementById("flash-messages");
        if (!container) {
            container = document.createElement("div");
            container.id = "flash-messages";
            document.body.appendChild(container);
        }
        let flash = document.createElement("div");
        flash.className = "flash " + category;
        flash.textContent = message;
        container.appendChild(flash);
        setTimeout(() => flash.remove(), 4000);
    }

    function chooseLocationMethod(method) {
        document.getElementById('autoLocateBtn').classList.remove('active');
        document.getElementById('manualLocateBtn').classList.remove('active');

        if (method === 'auto') {
            document.getElementById('autoLocateBtn').classList.add('active');
            locateMe();
        } else {
            document.getElementById('manualLocateBtn').classList.add('active');
            startManualPlacement();
        }

        document.getElementById('additionalInputs').style.display = 'block';
    }

    function locateMe() {
        if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var lat = position.coords.latitude;
                var lon = position.coords.longitude;
                placeTempMarker(lat, lon);
                map.setView([lat, lon], 15);
            }, function(error) {
                showFlash("Geolocation error: " + error.message, "error");
            });
        } else {
            showFlash("Geolocation is not supported by your browser.", "error");
        }
    }

    function startManualPlacement() {
        isManualPlacementMode = true;
        map.getContainer().style.cursor = 'crosshair';
        showFlash("Click on the map to place a pin.", "info");
    }

    function placeTempMarker(lat, lon) {
        if (tempMarker) {
            map.removeLayer(tempMarker);
        }
        tempMarker = L.marker([lat, lon], {draggable: true}).addTo(map);
        tempMarker.bindPopup("Grab and move the pin").openPopup();
    }

    function addSpotLocation() {
        var name = document.getElementById('name').value;
        if (name.trim() === "") {
            showFlash("Enter a description for the found spot.", "error");
            return;
        }
        if (tempMarker) {
            var position = tempMarker.getLatLng();
            addPin(position.lat, position.lng, name);
        } else {
            showFlash("First, place a pin.", "error");
        }
    }

    function addPin(lat, lon, name) {
        fetch('/api/locations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ lat: lat, lon: lon, name: name }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) { showFlash(data.error, "error"); return; }
            if (tempMarker) { map.removeLayer(tempMarker); tempMarker = null; }
            document.getElementById('name').value = '';
            loadLocations();
            map.setView([lat, lon], 15);
            isManualPlacementMode = false;
            map.getContainer().style.cursor = '';
            document.getElementById('additionalInputs').style.display = 'none';
            document.getElementById('autoLocateBtn').classList.remove('active');
            document.getElementById('manualLocateBtn').classList.remove('active');
            showFlash("Location added successfully!", "success");
        });
    }

    function checkinLocation(locationId) {
        // Your existing checkin logic
    }

    function loadLocations() {
        currentFilter = document.getElementById('heatFilter').value;
        fetch('/api/locations')
            .then(response => response.json())
            .then(locations => {
                for (var key in markers) { map.removeLayer(markers[key]); }
                markers = {};

                locations.forEach(loc => {
                    let show = false;
                    if (currentFilter === 'all') show = true;
                    else if (currentFilter === 'veryhot' && loc.heatscore >= 1.8) show = true;
                    else if (currentFilter === 'medium' && loc.heatscore <= 1.2 && loc.heatscore > 0.8) show = true;
                    else if (currentFilter === 'coldish' && loc.heatscore <= 0.8 && loc.heatscore > 0) show = true;
                    else if (currentFilter === 'grayout' && loc.heatscore == 0) show = true;

                    if (!show) return;

                    let iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-grey.png';
                    if (loc.heatscore > 1.2) iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png';
                    else if (loc.heatscore > 0.8) iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png';
                    else if (loc.heatscore > 0) iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png';

                    var markerOptions = {
                        icon: new L.Icon({
                            iconUrl: iconUrl,
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    };

                    var marker = L.marker([loc.lat, loc.lon], markerOptions).addTo(map);
                    markers[loc.id] = marker;

                    let popupContent = `<b>${loc.name}</b><br>Pinned at: ${new Date(loc.timestamp).toLocaleString()}<br>Checkins: <b>${loc.checkin_count}</b><br>`;
                    if (loc.most_common_tag) popupContent += `<p><b>Most popular tag:</b> ${loc.most_common_tag}</p>`;
                    marker.bindPopup(popupContent + `<button onclick="checkinLocation(${loc.id})">Checkin</button>`);
                });
            });
    }

    map.on('click', function(e) {
        if (isManualPlacementMode) {
            placeTempMarker(e.latlng.lat, e.latlng.lng);
            isManualPlacementMode = false;
            map.getContainer().style.cursor = '';
        }
    });

    loadLocations();
    setInterval(loadLocations, 60000);
</script>

</body>
</html>
